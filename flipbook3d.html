<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D PDF Flipbook - Zoom Enabled</title>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script> -->
    <script src="pdf.min.js"></script>
    <style>
        :root {
            --bg-color: #2c3e50;
            --page-width: 300px; 
            --page-height: 420px;
            --transition-speed: 0.6s;
            --accent-color: #3498db;
            --text-color: #ecf0f1;
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: var(--text-color);
        }

        /* --- CONTROLS AREA --- */
        .controls {
            background: rgba(0, 0, 0, 0.85);
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .btn-group {
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 5px 12px;
            border-radius: 25px;
        }

        .desktop-only { display: inline; }
        @media (max-width: 600px) {
            .desktop-only { display: none; }
            .btn-group { padding: 4px 8px; }
            #pageDisplay { font-size: 13px; min-width: 60px; text-align: center; }
        }

        input#pageInput {
            width: 45px;
            padding: 4px;
            background: transparent;
            border: 1px solid #555;
            color: white;
            text-align: center;
            border-radius: 4px;
            font-weight: bold;
            -moz-appearance: textfield;
        }

        input#pageInput::-webkit-outer-spin-button,
        input#pageInput::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        button {
            padding: 6px 14px;
            cursor: pointer;
            border-radius: 4px;
            border: none;
            background: #34495e;
            color: white;
            transition: 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        button:active { transform: scale(0.95); }
        button:hover { background: var(--accent-color); }

        /* --- VIEWPORT --- */
        #viewport {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            touch-action: none; 
        }

        .side-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 80px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            z-index: 1500;
            border-radius: 8px;
            transition: 0.3s;
            user-select: none;
        }
        .side-nav:hover { background: var(--accent-color); }
        .side-nav.left { left: 15px; }
        .side-nav.right { right: 15px; }

        @media (max-width: 768px) {
            .side-nav { display: none; }
        }

        /* --- BOOK 3D STRUCTURE --- */
        #zoom-container {
            transition: transform 0.1s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .book-aligner {
            width: var(--page-width);
            height: var(--page-height);
            position: relative;
            transition: transform var(--transition-speed) cubic-bezier(0.2, 1, 0.3, 1);
        }

        .align-cover { transform: translateX(0); }
        .align-open { transform: translateX(calc(var(--page-width) / 2)); }
        .align-end { transform: translateX(var(--page-width)); }

        @media (max-width: 768px) {
            .align-open { transform: translateX(0); }
            .align-end { transform: translateX(0); }
        }

        .book {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            perspective: 2500px;
        }

        .page {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            transform-origin: left;
            transform-style: preserve-3d;
            transition: transform var(--transition-speed) cubic-bezier(0.645, 0.045, 0.355, 1);
        }

        .page.flipped { transform: rotateY(-180deg); }

        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            background: white;
            overflow: hidden;
            border-radius: 2px 4px 4px 2px;
        }

        .front {
            box-shadow: inset 20px 0 50px rgba(0,0,0,0.05), 5px 0 15px rgba(0,0,0,0.1);
        }

        .back {
            transform: rotateY(180deg);
            border-radius: 4px 2px 2px 4px;
            box-shadow: inset -20px 0 50px rgba(0,0,0,0.05), -5px 0 15px rgba(0,0,0,0.1);
        }

        canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2rem;
            background: rgba(0,0,0,0.8);
            padding: 20px 40px;
            border-radius: 50px;
            pointer-events: none;
            z-index: 3000;
        }

        .front::after {
            content: "";
            position: absolute; top: 0; bottom: 0; left: 0; width: 40px;
            background: linear-gradient(to right, rgba(0,0,0,0.15), transparent);
            pointer-events: none;
        }
        .back::after {
            content: "";
            position: absolute; top: 0; bottom: 0; right: 0; width: 40px;
            background: linear-gradient(to left, rgba(0,0,0,0.15), transparent);
            pointer-events: none;
        }
        .click-area {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 25%; 
            z-index: 1000;
            cursor: pointer;
        }
/* Đảm bảo lớp page không chặn click của lớp dưới nó */
.page {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    transform-origin: left;
    transform-style: preserve-3d;
    transition: transform var(--transition-speed) cubic-bezier(0.645, 0.045, 0.355, 1);
    pointer-events: none; /* Quan trọng: Click xuyên qua các lớp rỗng */
}

/* Chỉ những gì hiển thị mới nhận click */
.front, .back {
    pointer-events: auto; 
    z-index: 10;
}

.click-area {
    position: absolute;
    top: 0;
    bottom: 0;
    z-index: 5000; /* Luôn nằm trên cùng của mặt trang */
    cursor: pointer;
    background: rgba(0,0,0,0); /* Trong suốt */
}
    </style>
</head>
<body>

<div class="controls">
    <div class="btn-group">
        <button onclick="prevPage()">❮ Prev</button>
        <span id="pageDisplay">Loading...</span>
        <button onclick="nextPage()">Next ❯</button>
    </div>

    <div class="btn-group">
        <span class="desktop-only">Trang:</span>
        <input type="number" id="pageInput" min="1" value="1" onchange="goToPage()">
    </div>

    <div class="btn-group">
        <button onclick="zoomOut()">−</button>
        <span id="zoom-level" style="font-size: 13px; min-width: 40px; text-align:center;">100%</span>
        <button onclick="zoomIn()">+</button>
        <button onclick="resetView()">Reset</button>
    </div>
</div>

<div id="viewport">
    <div id="loading">Đang tải PDF...</div>
    
    <div class="side-nav left" onclick="prevPage()">‹</div>
    <div class="side-nav right" onclick="nextPage()">›</div>

    <div id="zoom-container">
        <div id="book-aligner" class="book-aligner align-cover">
            <div id="book" class="book"></div>
        </div>
    </div>
</div>

<script>
    // --- CẤU HÌNH ---
    const pdfUrl = 'book.pdf'; 
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    // pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.min.js';

    let pdfDoc = null;
    let totalPages = 0;
    let currentSheet = 0; 
    const sheetsArray = [];
    
    let zoom = 1;
    let translateX = 0; 
    let translateY = 0;
    let isDragging = false;
    let startX, startY;

    // Các biến cho Pinch Zoom
    let initialPinchDistance = 0;
    let initialZoom = 1;

    function updateBookDimensions() {
        const viewport = document.getElementById('viewport');
        const vWidth = viewport.clientWidth;
        const vHeight = viewport.clientHeight;
        let pWidth, pHeight;
        const aspectRatio = 0.707; 

        if (vWidth < 768) {
            pWidth = vWidth * 0.92; 
            pHeight = pWidth / aspectRatio;
            if (pHeight > vHeight * 0.85) {
                pHeight = vHeight * 0.85;
                pWidth = pHeight * aspectRatio;
            }
        } else {
            pHeight = vHeight * 0.85; 
            pWidth = pHeight * aspectRatio;
        }

        document.documentElement.style.setProperty('--page-width', `${Math.round(pWidth)}px`);
        document.documentElement.style.setProperty('--page-height', `${Math.round(pHeight)}px`);
    }

    async function init() {
        updateBookDimensions();
        window.addEventListener('resize', updateBookDimensions);

        try {
            pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
            totalPages = pdfDoc.numPages;
            document.getElementById('pageInput').max = totalPages;
            document.getElementById('loading').style.display = 'none';
            await renderBook();
            updateUI();
        } catch (err) {
            console.error(err);
            document.getElementById('loading').innerText = "Lỗi: Không tìm thấy file " + pdfUrl;
            document.getElementById('loading').style.backgroundColor = "red";
        }
    }

async function renderBook() {
    const book = document.getElementById('book');
    book.innerHTML = ''; 
    const totalSheets = Math.ceil(totalPages / 2);

    for (let i = 0; i < totalSheets; i++) {
        const pageNumFront = i * 2 + 1;
        const pageNumBack = i * 2 + 2;
        const sheetEl = document.createElement('div');
        sheetEl.className = 'page';
        sheetEl.style.zIndex = totalSheets - i; 
        
        // --- Mặt trước (Nằm bên phải) ---
        const front = document.createElement('div');
        front.className = 'front';
        
        const nextTrigger = document.createElement('div');
        nextTrigger.className = 'click-area';
        nextTrigger.style.right = '0';
        nextTrigger.style.width = '40%'; // Vùng nhấn lật tới
        nextTrigger.onclick = (e) => {
            e.stopPropagation();
            nextPage();
        };
        front.appendChild(nextTrigger);
        await renderPageToCanvas(pageNumFront, front);
        sheetEl.appendChild(front);

        // --- Mặt sau (Sẽ nằm bên trái sau khi lật) ---
        const back = document.createElement('div');
        back.className = 'back';
        
        const prevTrigger = document.createElement('div');
        prevTrigger.className = 'click-area';
        prevTrigger.style.left = '0';
        prevTrigger.style.width = '40%'; // Vùng nhấn lật lui
        prevTrigger.onclick = (e) => {
            e.stopPropagation();
            prevPage();
        };
        back.appendChild(prevTrigger);

        if (pageNumBack <= totalPages) {
            await renderPageToCanvas(pageNumBack, back);
        } else {
            back.style.backgroundColor = "#ddd"; 
        }
        sheetEl.appendChild(back);

        book.appendChild(sheetEl);
        sheetsArray.push(sheetEl);
    }
}

    async function renderPageToCanvas(num, container) {
        try {
            const page = await pdfDoc.getPage(num);
            const cssWidth = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--page-width'));
            const desiredWidth = cssWidth * 2; 
            const viewport = page.getViewport({ scale: 1 });
            const scale = desiredWidth / viewport.width;
            const scaledViewport = page.getViewport({ scale: scale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = scaledViewport.height;
            canvas.width = scaledViewport.width;

            await page.render({ canvasContext: context, viewport: scaledViewport }).promise;
            container.appendChild(canvas);
        } catch (e) { console.error("Error rendering page " + num, e); }
    }

    function nextPage() {
        if (currentSheet < sheetsArray.length) {
            sheetsArray[currentSheet].classList.add('flipped');
            currentSheet++;
            updateUI();
        }
    }

    function prevPage() {
        if (currentSheet > 0) {
            currentSheet--;
            sheetsArray[currentSheet].classList.remove('flipped');
            updateUI();
        }
    }

    function goToPage() {
        const input = document.getElementById('pageInput');
        let p = parseInt(input.value);
        if (isNaN(p) || p < 1) p = 1;
        if (p > totalPages) p = totalPages;
        const targetSheet = Math.floor((p - 1) / 2); 

        sheetsArray.forEach((sheet, idx) => {
             if (idx < targetSheet) sheet.classList.add('flipped');
             else sheet.classList.remove('flipped');
        });
        
        if (p % 2 === 0) {
             sheetsArray[targetSheet].classList.add('flipped');
             currentSheet = targetSheet + 1;
        } else {
             currentSheet = targetSheet;
        }
        updateUI();
        input.blur();
    }

    function updateUI() {
        const aligner = document.getElementById('book-aligner');
        if (currentSheet === 0) aligner.className = 'book-aligner align-cover';
        else if (currentSheet === sheetsArray.length) aligner.className = 'book-aligner align-end';
        else aligner.className = 'book-aligner align-open';

        const display = document.getElementById('pageDisplay');
        const pLeft = currentSheet * 2;
        const pRight = pLeft + 1;
        
        if (currentSheet === 0) {
            display.innerText = `Trang 1 / ${totalPages}`;
            document.getElementById('pageInput').value = 1;
        } else if (currentSheet === sheetsArray.length) {
            display.innerText = `Hết / ${totalPages}`;
            document.getElementById('pageInput').value = totalPages;
        } else {
            display.innerText = `Trang ${pLeft}-${pRight > totalPages ? '-' : pRight} / ${totalPages}`;
            document.getElementById('pageInput').value = pLeft;
        }

        sheetsArray.forEach((sheet, index) => {
            if (index < currentSheet) sheet.style.zIndex = index;
            else sheet.style.zIndex = sheetsArray.length - index + currentSheet; 
        });
    }

    // --- ZOOM & PAN LOGIC ---
    const zoomContainer = document.getElementById('zoom-container');
    const viewportEl = document.getElementById('viewport');

    function applyTransform() {
        zoomContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom})`;
    }

    function zoomIn() { zoom = Math.min(zoom + 0.25, 3); updateZoomText(); }
    function zoomOut() { zoom = Math.max(zoom - 0.25, 0.5); updateZoomText(); }
    function resetView() { zoom = 1; translateX = 0; translateY = 0; updateZoomText(); }
    function updateZoomText() { 
        document.getElementById('zoom-level').innerText = Math.round(zoom * 100) + '%'; 
        applyTransform(); 
    }

    // Wheel Zoom (Desktop)
    viewportEl.addEventListener('wheel', e => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        zoom = Math.min(Math.max(0.5, zoom + delta), 3);
        updateZoomText();
    }, { passive: false });

    // Mouse Pan
    viewportEl.addEventListener('mousedown', e => {
        if(e.target.closest('button') || e.target.closest('input')) return;
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        viewportEl.style.cursor = 'grabbing';
    });

    window.addEventListener('mousemove', e => {
        if (!isDragging) return;
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        applyTransform();
    });

    window.addEventListener('mouseup', () => { 
        setTimeout(() => isDragging = false, 50); 
        viewportEl.style.cursor = 'default'; 
    });

    // Touch Support (Swipe, Pan, Pinch Zoom)
    let touchStartX = 0;
    function getDistance(touches) {
        return Math.hypot(touches[0].pageX - touches[1].pageX, touches[0].pageY - touches[1].pageY);
    }

    viewportEl.addEventListener('touchstart', e => {
        if (e.touches.length === 2) {
            initialPinchDistance = getDistance(e.touches);
            initialZoom = zoom;
        } else if (e.touches.length === 1) {
            touchStartX = e.touches[0].clientX;
            if (zoom > 1.05) {
                startX = e.touches[0].clientX - translateX;
                startY = e.touches[0].clientY - translateY;
                isDragging = true;
            }
        }
    }, { passive: false });

    viewportEl.addEventListener('touchmove', e => {
        if (e.touches.length === 2) {
            e.preventDefault();
            const currentDistance = getDistance(e.touches);
            const pinchScale = currentDistance / initialPinchDistance;
            zoom = Math.min(Math.max(0.5, initialZoom * pinchScale), 3);
            updateZoomText();
        } else if (zoom > 1.05 && isDragging && e.touches.length === 1) {
            e.preventDefault(); 
            translateX = e.touches[0].clientX - startX;
            translateY = e.touches[0].clientY - startY;
            applyTransform();
        }
    }, { passive: false });

    viewportEl.addEventListener('touchend', e => {
        if (e.touches.length < 2 && zoom <= 1.05) {
            const touchEndX = e.changedTouches[0].clientX;
            const diffX = touchEndX - touchStartX;
            if (diffX > 60) prevPage();
            else if (diffX < -60) nextPage();
        }
        isDragging = false;
    });

    window.addEventListener('keydown', (e) => {
        if (document.activeElement.id === 'pageInput') {
             if (e.key === 'Enter') goToPage();
             return;
        }
        if (e.key === 'ArrowRight') nextPage();
        if (e.key === 'ArrowLeft') prevPage();
        if (e.key === '+' || e.key === '=') zoomIn();
        if (e.key === '-') zoomOut();
    });

    init();
</script>

</body>
</html>