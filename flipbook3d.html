<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D PDF Flipbook</title>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script> -->
    <script src="pdf.min.js"></script> 
    <style>
        :root {
            --bg-color: #121212;
            --page-width: 400px;
            --page-height: 580px;
            --transition-speed: 0.7s;
            --accent-color: #3498db;
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Top Controls */
        .controls {
            background: rgba(0, 0, 0, 0.9);
            padding: 10px 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            border-bottom: 1px solid #333;
        }

        .btn-group { display: flex; gap: 10px; align-items: center; }

        input#pageInput {
            width: 60px;
            padding: 5px;
            background: #222;
            border: 1px solid #444;
            color: white;
            text-align: center;
            border-radius: 4px;
            font-weight: bold;
            outline: none;
            /* Ẩn mũi tên tăng giảm mặc định của trình duyệt */
            appearance: textfield;
            -moz-appearance: textfield;
        }
        
        input#pageInput::-webkit-inner-spin-button, 
        input#pageInput::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        input#pageInput:focus { border-color: var(--accent-color); }

        button {
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 6px;
            border: 1px solid #444;
            background: #252525;
            color: white;
            transition: 0.3s;
        }

        button:hover { background: var(--accent-color); border-color: white; }

        #viewport {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .side-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 100px;
            background: rgba(255, 255, 255, 0.03);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            cursor: pointer;
            z-index: 1500;
            user-select: none;
            transition: 0.3s;
            border-radius: 10px;
        }

        .side-nav:hover { background: rgba(52, 152, 219, 0.4); }
        .side-nav.left { left: 20px; }
        .side-nav.right { right: 20px; }

        #zoom-container {
            transition: transform 0.1s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .book-aligner {
            width: var(--page-width);
            height: var(--page-height);
            position: relative;
            transition: transform var(--transition-speed) cubic-bezier(0.2, 1, 0.3, 1);
        }

        .align-cover { transform: translateX(0); }
        .align-open { transform: translateX(calc(var(--page-width) / 2)); }
        .align-end { transform: translateX(var(--page-width)); }

        .book {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            perspective: 2500px;
        }

        .page {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            transform-origin: left;
            transform-style: preserve-3d;
            transition: transform var(--transition-speed) cubic-bezier(0.645, 0.045, 0.355, 1);
            pointer-events: none;
        }

        .page.clickable { pointer-events: auto; }

        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            background: white;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.1), 5px 5px 15px rgba(0,0,0,0.4);
            border-radius: 2px 5px 5px 2px;
        }

        .back { 
            transform: rotateY(180deg);
            border-radius: 5px 2px 2px 5px;
        }

        canvas { width: 100%; height: 100%; display: block; border-radius: inherit; }
        .flipped { transform: rotateY(-180deg); }
        #loading { color: white; font-weight: bold; position: absolute; }
    </style>
</head>
<body>

<div class="controls">
    <div class="btn-group">
        <button onclick="prevPage()">←</button>
        <span id="pageDisplay" style="min-width: 100px; text-align: center;">Trang 1</span>
        <button onclick="nextPage()">→</button>
    </div>

    <div class="btn-group" style="border-left: 1px solid #444; padding-left: 15px;">
        <span>Đến trang:</span>
        <input type="number" id="pageInput" min="1" value="1" onchange="goToPage()">
    </div>

    <div class="btn-group" style="border-left: 1px solid #444; padding-left: 15px;">
        <button onclick="zoomOut()">-</button>
        <span id="zoom-level">100%</span>
        <button onclick="zoomIn()">+</button>
        <button onclick="resetView()">Reset</button>
    </div>
</div>

<div id="viewport">
    <div id="loading">ĐANG TẢI PDF...</div>
    
    <div class="side-nav left" onclick="prevPage()">‹</div>
    <div class="side-nav right" onclick="nextPage()">›</div>

    <div id="zoom-container">
        <div id="book-aligner" class="book-aligner align-cover">
            <div id="book" class="book"></div>
        </div>
    </div>
</div>

<script>
    const pdfUrl = 'book.pdf'; 
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    // pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.min.js';

    let zoom = 1, translateX = 0, translateY = 0, isDragging = false, startX, startY;
    let currentSheet = 0; 
    let totalPages = 0;
    const sheetsArray = [];

    const pageInput = document.getElementById('pageInput');

    // --- FIX: Khóa tính năng tự tăng giảm của Input ---
    // Chặn cuộn chuột trong ô input
    pageInput.addEventListener('wheel', (e) => e.preventDefault(), { passive: false });
    
    // Chặn phím mũi tên Lên và Xuống
    pageInput.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
            e.preventDefault();
        }
    });

    async function init() {
        try {
            const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
            totalPages = pdf.numPages;
            pageInput.max = totalPages;
            document.getElementById('loading').style.display = 'none';
            const book = document.getElementById('book');

            for (let i = 1; i <= totalPages; i += 2) {
                const sheetEl = document.createElement('div');
                sheetEl.className = 'page clickable';
                sheetEl.style.zIndex = Math.ceil(totalPages/2) - sheetsArray.length;

                const front = document.createElement('div');
                front.className = 'front';
                await renderPage(pdf, i, front);
                sheetEl.appendChild(front);

                const back = document.createElement('div');
                back.className = 'back';
                if (i + 1 <= totalPages) {
                    await renderPage(pdf, i + 1, back);
                } else {
                    back.style.background = "#222";
                }
                sheetEl.appendChild(back);

                sheetEl.onclick = (e) => {
                    if (zoom > 1.2) return;
                    e.stopPropagation();
                    if (sheetEl.classList.contains('flipped')) prevPage();
                    else nextPage();
                };

                book.appendChild(sheetEl);
                sheetsArray.push(sheetEl);
            }
            updateUI();
        } catch (err) {
            document.getElementById('loading').innerText = "LỖI TẢI PDF.";
        }
    }

    async function renderPage(pdf, num, container) {
        const page = await pdf.getPage(num);
        const canvas = document.createElement('canvas');
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
        container.appendChild(canvas);
    }

    function nextPage() {
        if (currentSheet < sheetsArray.length) {
            sheetsArray[currentSheet].classList.add('flipped');
            currentSheet++;
            updateUI();
        }
    }

    function prevPage() {
        if (currentSheet > 0) {
            currentSheet--;
            sheetsArray[currentSheet].classList.remove('flipped');
            updateUI();
        }
    }

    function goToPage() {
        let targetPage = parseInt(pageInput.value);
        if (isNaN(targetPage) || targetPage < 1) targetPage = 1;
        if (targetPage > totalPages) targetPage = totalPages;

        const targetSheet = Math.floor(targetPage / 2);
        
        sheetsArray.forEach((sheet, index) => {
            if (index < targetSheet) sheet.classList.add('flipped');
            else sheet.classList.remove('flipped');
        });

        currentSheet = targetSheet;
        updateUI();
        pageInput.blur(); 
    }

    function updateUI() {
        const aligner = document.getElementById('book-aligner');
        
        if (currentSheet === 0) aligner.className = 'book-aligner align-cover';
        else if (currentSheet === sheetsArray.length) aligner.className = 'book-aligner align-end';
        else aligner.className = 'book-aligner align-open';

        const display = document.getElementById('pageDisplay');

        if (currentSheet === 0) {
            display.innerText = `Trang 1 / ${totalPages}`;
            pageInput.value = 1;
        } else if (currentSheet === sheetsArray.length) {
            display.innerText = `Trang ${totalPages} / ${totalPages}`;
            pageInput.value = totalPages;
        } else {
            const p2 = currentSheet * 2;
            const p3 = p2 + 1;
            display.innerText = `Trang ${p2}-${p3 > totalPages ? totalPages : p3} / ${totalPages}`;
            pageInput.value = p2;
        }

        sheetsArray.forEach((s, idx) => {
            s.style.zIndex = s.classList.contains('flipped') ? idx + 1 : sheetsArray.length - idx;
        });
    }

    const zoomContainer = document.getElementById('zoom-container');
    const viewport = document.getElementById('viewport');
    function applyTransform() { zoomContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom})`; }
    function zoomIn() { zoom = Math.min(zoom + 0.2, 4); updateZoomUI(); }
    function zoomOut() { zoom = Math.max(zoom - 0.2, 0.5); updateZoomUI(); }
    function resetView() { zoom = 1; translateX = 0; translateY = 0; updateZoomUI(); }
    function updateZoomUI() { document.getElementById('zoom-level').innerText = `${Math.round(zoom * 100)}%`; applyTransform(); }

    viewport.onwheel = (e) => { e.preventDefault(); e.deltaY < 0 ? zoomIn() : zoomOut(); };
    viewport.onmousedown = (e) => { 
        if(e.target.closest('.side-nav') || e.target.closest('.controls')) return;
        isDragging = true; 
        startX = e.clientX - translateX; 
        startY = e.clientY - translateY; 
    };
    window.onmousemove = (e) => { if (!isDragging) return; translateX = e.clientX - startX; translateY = e.clientY - startY; applyTransform(); };
    window.onmouseup = () => isDragging = false;

    window.onkeydown = (e) => {
        if (document.activeElement.id === 'pageInput') {
            if (e.key === 'Enter') goToPage();
            // Cho phép phím mũi tên Trái/Phải di chuyển con trỏ văn bản, nhưng chặn phím Lên/Xuống
            if (e.key === "ArrowUp" || e.key === "ArrowDown") e.preventDefault();
            return;
        }
        if (e.key === "ArrowRight") nextPage();
        if (e.key === "ArrowLeft") prevPage();
    };

    init();
</script>

</body>
</html>