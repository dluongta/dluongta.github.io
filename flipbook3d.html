<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D PDF Flipbook</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root {
            --bg-color: #2c3e50;
            /* Các biến này sẽ được JS cập nhật tự động theo màn hình */
            --page-width: 300px; 
            --page-height: 420px;
            --transition-speed: 0.6s;
            --accent-color: #3498db;
            --text-color: #ecf0f1;
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            overflow: hidden; /* Chặn thanh cuộn của trình duyệt */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: var(--text-color);
        }

        /* --- CONTROLS AREA --- */
        .controls {
            background: rgba(0, 0, 0, 0.85);
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .btn-group {
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 5px 12px;
            border-radius: 25px;
        }

        /* Ẩn bớt text thừa trên mobile */
        .desktop-only { display: inline; }
        @media (max-width: 600px) {
            .desktop-only { display: none; }
            .btn-group { padding: 4px 8px; }
            #pageDisplay { font-size: 13px; min-width: 60px; text-align: center; }
        }

        input#pageInput {
            width: 40px;
            padding: 4px;
            background: transparent;
            border: 1px solid #555;
            color: white;
            text-align: center;
            border-radius: 4px;
            font-weight: bold;
        }
        
        button {
            padding: 6px 14px;
            cursor: pointer;
            border-radius: 4px;
            border: none;
            background: #34495e;
            color: white;
            transition: 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        button:active { transform: scale(0.95); }
        button:hover { background: var(--accent-color); }

        /* --- VIEWPORT --- */
        #viewport {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            touch-action: none; /* Quan trọng cho thao tác vuốt */
        }

        /* Nút điều hướng 2 bên */
        .side-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 80px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            z-index: 1500;
            border-radius: 8px;
            transition: 0.3s;
            user-select: none;
        }
        .side-nav:hover { background: var(--accent-color); }
        .side-nav.left { left: 15px; }
        .side-nav.right { right: 15px; }

        @media (max-width: 768px) {
            .side-nav { display: none; } /* Ẩn nút mũi tên trên mobile để dùng vuốt */
        }

        /* --- BOOK 3D STRUCTURE --- */
        #zoom-container {
            transition: transform 0.1s ease-out; /* Mượt mà khi zoom/pan */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .book-aligner {
            width: var(--page-width);
            height: var(--page-height);
            position: relative;
            transition: transform var(--transition-speed) cubic-bezier(0.2, 1, 0.3, 1);
        }

        /* Logic căn chỉnh vị trí sách */
        .align-cover { transform: translateX(0); } /* Đóng bìa: Căn giữa */
        .align-open { transform: translateX(calc(var(--page-width) / 2)); } /* Mở sách: Dời sang phải */
        .align-end { transform: translateX(var(--page-width)); } /* Trang cuối */

        @media (max-width: 768px) {
            .align-open { transform: translateX(0); } /* Mobile luôn căn giữa */
            .align-end { transform: translateX(0); }
        }

        .book {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            perspective: 2500px;
        }

        .page {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            transform-origin: left; /* Quay quanh gáy sách trái */
            transform-style: preserve-3d;
            transition: transform var(--transition-speed) cubic-bezier(0.645, 0.045, 0.355, 1);
        }

        .page.flipped { transform: rotateY(-180deg); }

        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; /* Ẩn mặt sau */
            background: white;
            overflow: hidden;
            /* Tạo bóng đổ nhẹ giúp tách biệt các trang */
            border-radius: 2px 4px 4px 2px;
        }

        .front {
             /* Bóng đổ phía trong gáy */
            box-shadow: inset 20px 0 50px rgba(0,0,0,0.05), 5px 0 15px rgba(0,0,0,0.1);
        }

        .back {
            transform: rotateY(180deg);
            border-radius: 4px 2px 2px 4px;
            box-shadow: inset -20px 0 50px rgba(0,0,0,0.05), -5px 0 15px rgba(0,0,0,0.1);
        }

        canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2rem;
            background: rgba(0,0,0,0.8);
            padding: 20px 40px;
            border-radius: 50px;
            pointer-events: none;
            z-index: 3000;
        }

        /* Hiệu ứng gradient ở gáy sách cho chân thực */
        .front::after {
            content: "";
            position: absolute; top: 0; bottom: 0; left: 0; width: 40px;
            background: linear-gradient(to right, rgba(0,0,0,0.15), transparent);
            pointer-events: none;
        }
        .back::after {
            content: "";
            position: absolute; top: 0; bottom: 0; right: 0; width: 40px;
            background: linear-gradient(to left, rgba(0,0,0,0.15), transparent);
            pointer-events: none;
        }
        input#pageInput {
            width: 45px;
            padding: 4px;
            background: transparent;
            border: 1px solid #555;
            color: white;
            text-align: center;
            border-radius: 4px;
            font-weight: bold;
            /* Tắt mũi tên tăng giảm trên Firefox */
            -moz-appearance: textfield;
        }

        /* Tắt mũi tên tăng giảm trên Chrome, Safari, Edge, Opera */
        input#pageInput::-webkit-outer-spin-button,
        input#pageInput::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
    </style>
</head>
<body>

<div class="controls">
    <div class="btn-group">
        <button onclick="prevPage()">❮ Prev</button>
        <span id="pageDisplay">Loading...</span>
        <button onclick="nextPage()">Next ❯</button>
    </div>

    <div class="btn-group">
        <span class="desktop-only">Trang:</span>
        <input type="number" id="pageInput" min="1" value="1" onchange="goToPage()">    </div>

    <div class="btn-group">
        <button onclick="zoomOut()">−</button>
        <span id="zoom-level" style="font-size: 13px; min-width: 40px; text-align:center;">100%</span>
        <button onclick="zoomIn()">+</button>
        <button onclick="resetView()">Reset</button>
    </div>
</div>

<div id="viewport">
    <div id="loading">Đang tải PDF...</div>
    
    <div class="side-nav left" onclick="prevPage()">‹</div>
    <div class="side-nav right" onclick="nextPage()">›</div>

    <div id="zoom-container">
        <div id="book-aligner" class="book-aligner align-cover">
            <div id="book" class="book"></div>
        </div>
    </div>
</div>

<script>
    // --- CẤU HÌNH ---
    const pdfUrl = 'book.pdf'; // Thay đổi đường dẫn file PDF của bạn tại đây
    
    // Sử dụng CDN Worker (Không cần tải file worker về)
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pdfDoc = null;
    let totalPages = 0;
    let currentSheet = 0; // Index của tờ giấy hiện tại (0 là bìa)
    const sheetsArray = [];
    
    // Các biến Zoom / Pan
    let zoom = 1;
    let translateX = 0; 
    let translateY = 0;
    let isDragging = false;
    let startX, startY;

    // --- RESPONSIVE LOGIC: Tự động tính kích thước sách ---
    function updateBookDimensions() {
        const viewport = document.getElementById('viewport');
        const vWidth = viewport.clientWidth;
        const vHeight = viewport.clientHeight;
        let pWidth, pHeight;

        // Tỷ lệ khung hình mong muốn của trang A4 (xấp xỉ 0.707)
        const aspectRatio = 0.707; 

        if (vWidth < 768) {
            // Mobile: Ưu tiên chiều rộng
            pWidth = vWidth * 0.92; 
            pHeight = pWidth / aspectRatio;
            
            // Nếu quá cao so với màn hình
            if (pHeight > vHeight * 0.85) {
                pHeight = vHeight * 0.85;
                pWidth = pHeight * aspectRatio;
            }
        } else {
            // Desktop: Ưu tiên chiều cao
            pHeight = vHeight * 0.85; 
            pWidth = pHeight * aspectRatio;
        }

        document.documentElement.style.setProperty('--page-width', `${Math.round(pWidth)}px`);
        document.documentElement.style.setProperty('--page-height', `${Math.round(pHeight)}px`);
    }

    // --- KHỞI TẠO ---
    async function init() {
        updateBookDimensions();
        window.addEventListener('resize', () => {
            updateBookDimensions();
        });

        try {
            pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
            totalPages = pdfDoc.numPages;
            document.getElementById('pageInput').max = totalPages;
            document.getElementById('loading').style.display = 'none';

            await renderBook();
            updateUI();
        } catch (err) {
            console.error(err);
            document.getElementById('loading').innerText = "Lỗi: Không tìm thấy file " + pdfUrl;
            document.getElementById('loading').style.backgroundColor = "red";
        }
    }

    async function renderBook() {
        const book = document.getElementById('book');
        book.innerHTML = ''; 

        // Tính tổng số tờ giấy cần thiết (Mỗi tờ có 2 mặt)
        const totalSheets = Math.ceil(totalPages / 2);

        for (let i = 0; i < totalSheets; i++) {
            const pageNumFront = i * 2 + 1;
            const pageNumBack = i * 2 + 2;

            const sheetEl = document.createElement('div');
            sheetEl.className = 'page';
            sheetEl.style.zIndex = totalSheets - i; 
            
            // Mặt trước
            const front = document.createElement('div');
            front.className = 'front';
            await renderPageToCanvas(pageNumFront, front);
            sheetEl.appendChild(front);

            // Mặt sau
            const back = document.createElement('div');
            back.className = 'back';
            if (pageNumBack <= totalPages) {
                await renderPageToCanvas(pageNumBack, back);
            } else {
                back.style.backgroundColor = "#ddd"; // Bìa sau cùng trắng/xám
            }
            sheetEl.appendChild(back);

            // Sự kiện Click để lật
            sheetEl.onclick = (e) => {
                if (Math.abs(translateX) > 5 || Math.abs(translateY) > 5) return; // Đang kéo thì không lật
                
                if (sheetEl.classList.contains('flipped')) {
                    if (currentSheet === i + 1) prevPage();
                } else {
                    if (currentSheet === i) nextPage();
                }
            };

            book.appendChild(sheetEl);
            sheetsArray.push(sheetEl);
        }
    }

    async function renderPageToCanvas(num, container) {
        try {
            const page = await pdfDoc.getPage(num);
            
            // Render độ phân giải cao hơn kích thước thực để khi zoom không bị vỡ
            const cssWidth = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--page-width'));
            const desiredWidth = cssWidth * 2; // Render gấp đôi kích thước hiển thị
            
            const viewport = page.getViewport({ scale: 1 });
            const scale = desiredWidth / viewport.width;
            const scaledViewport = page.getViewport({ scale: scale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = scaledViewport.height;
            canvas.width = scaledViewport.width;

            await page.render({ canvasContext: context, viewport: scaledViewport }).promise;
            container.appendChild(canvas);
        } catch (e) {
            console.error("Lỗi render trang " + num, e);
        }
    }

    // --- LOGIC ĐIỀU KHIỂN ---
    function nextPage() {
        if (currentSheet < sheetsArray.length) {
            sheetsArray[currentSheet].classList.add('flipped');
            currentSheet++;
            updateUI();
        }
    }

    function prevPage() {
        if (currentSheet > 0) {
            currentSheet--;
            sheetsArray[currentSheet].classList.remove('flipped');
            updateUI();
        }
    }

    function goToPage() {
        const input = document.getElementById('pageInput');
        let p = parseInt(input.value);
        if (isNaN(p) || p < 1) p = 1;
        if (p > totalPages) p = totalPages;
        
        // Tính toán tờ (Sheet) tương ứng
        const targetSheet = Math.floor((p - 1) / 2); 

        // Cập nhật trạng thái lật cho tất cả các trang
        for (let i = 0; i < sheetsArray.length; i++) {
            if (i < Math.ceil(p/2) && (i <= targetSheet || p > i*2+1)) { 
                // Logic: Lật các trang trước trang đích
                if (i <= targetSheet) {
                    // Nếu đích là mặt sau (trang chẵn), tờ hiện tại phải được tính là đã qua
                     if ((p-1) >= (i*2+1)) sheetsArray[i].classList.add('flipped');
                     else sheetsArray[i].classList.remove('flipped'); // Trường hợp trang lẻ đang xem
                     
                     // Fix đơn giản: cứ lật hết các trang trước targetSheet
                     if (i < targetSheet) sheetsArray[i].classList.add('flipped');
                }
            } 
        }
        
        // Reset đơn giản hơn:
        sheetsArray.forEach((sheet, idx) => {
             if (idx < targetSheet) sheet.classList.add('flipped');
             else sheet.classList.remove('flipped');
        });
        
        // Nếu trang muốn đến là trang Chẵn (mặt sau), thì tờ đó cũng phải lật
        if (p % 2 === 0) {
             sheetsArray[targetSheet].classList.add('flipped');
             currentSheet = targetSheet + 1;
        } else {
             currentSheet = targetSheet;
        }

        updateUI();
        input.blur();
    }

    function updateUI() {
        const aligner = document.getElementById('book-aligner');
        
        // Xử lý vị trí sách
        if (currentSheet === 0) aligner.className = 'book-aligner align-cover';
        else if (currentSheet === sheetsArray.length) aligner.className = 'book-aligner align-end';
        else aligner.className = 'book-aligner align-open';

        // Text hiển thị
        const display = document.getElementById('pageDisplay');
        const pLeft = currentSheet * 2;
        const pRight = pLeft + 1;
        
        if (currentSheet === 0) {
            display.innerText = `Trang 1 / ${totalPages}`;
            document.getElementById('pageInput').value = 1;
        } else if (currentSheet === sheetsArray.length) {
            display.innerText = `Hết / ${totalPages}`;
            document.getElementById('pageInput').value = totalPages;
        } else {
            display.innerText = `Trang ${pLeft}-${pRight > totalPages ? '-' : pRight} / ${totalPages}`;
            document.getElementById('pageInput').value = pLeft;
        }

        // Cập nhật Z-Index động để tránh lỗi hiển thị khi lật
        sheetsArray.forEach((sheet, index) => {
            if (index < currentSheet) {
                // Các trang bên trái: Trang càng xa (index thấp) thì z-index thấp
                sheet.style.zIndex = index;
            } else {
                // Các trang bên phải: Trang càng gần (index thấp) thì z-index cao
                sheet.style.zIndex = sheetsArray.length - index + currentSheet; 
            }
        });
    }

    // --- ZOOM & PAN & TOUCH SWIPE ---
    const zoomContainer = document.getElementById('zoom-container');
    const viewportEl = document.getElementById('viewport');

    function applyTransform() {
        zoomContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom})`;
    }

    function zoomIn() { zoom = Math.min(zoom + 0.25, 3); updateZoomText(); }
    function zoomOut() { zoom = Math.max(zoom - 0.25, 0.5); updateZoomText(); }
    function resetView() { zoom = 1; translateX = 0; translateY = 0; updateZoomText(); }
    function updateZoomText() { 
        document.getElementById('zoom-level').innerText = Math.round(zoom * 100) + '%'; 
        applyTransform(); 
    }

    // Panning (Kéo thả) Mouse
    viewportEl.addEventListener('mousedown', e => {
        if(e.target.closest('button') || e.target.closest('input')) return;
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        viewportEl.style.cursor = 'grabbing';
    });

    window.addEventListener('mousemove', e => {
        if (!isDragging) return;
        e.preventDefault();
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        applyTransform();
    });

    window.addEventListener('mouseup', () => { isDragging = false; viewportEl.style.cursor = 'default'; });

    // Touch Handling (Swipe + Pan)
    let touchStartX = 0;

    viewportEl.addEventListener('touchstart', e => {
        if (e.touches.length === 1) {
            touchStartX = e.touches[0].clientX;
            // Nếu đang zoom, cho phép Pan
            if (zoom > 1.05) {
                startX = e.touches[0].clientX - translateX;
                startY = e.touches[0].clientY - translateY;
                isDragging = true;
            }
        }
    }, { passive: false });

    viewportEl.addEventListener('touchmove', e => {
        if (zoom > 1.05 && isDragging) {
            e.preventDefault(); 
            translateX = e.touches[0].clientX - startX;
            translateY = e.touches[0].clientY - startY;
            applyTransform();
        }
    }, { passive: false });

    viewportEl.addEventListener('touchend', e => {
        isDragging = false;
        // Nếu không zoom, tính toán swipe
        if (zoom <= 1.05) {
            const touchEndX = e.changedTouches[0].clientX;
            const diffX = touchEndX - touchStartX;
            
            // Vuốt > 50px mới tính là lật trang
            if (diffX > 50) prevPage(); // Vuốt sang phải -> Trang trước
            else if (diffX < -50) nextPage(); // Vuốt sang trái -> Trang sau
        }
    });

    // Keyboard support
    window.addEventListener('keydown', (e) => {
        if (document.activeElement.id === 'pageInput') {
             if (e.key === 'Enter') goToPage();
             return;
        }
        if (e.key === 'ArrowRight') nextPage();
        if (e.key === 'ArrowLeft') prevPage();
        if (e.key === '+' || e.key === '=') zoomIn();
        if (e.key === '-') zoomOut();
    });

    init();
</script>

</body>
</html>