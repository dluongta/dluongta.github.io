<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Text Speech</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f4f6f8;
      color: #333;
    }

    .container {
      max-width: 680px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, .08);
      text-align: center;
    }

    h1 {
      margin-bottom: 20px;
      font-size: 1.5rem;
      color: #2c3e50;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      padding: 15px;
      font-size: 16px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      background: #fafafa;
      box-sizing: border-box;
      resize: vertical;
      transition: border .3s;
    }

    textarea:focus {
      outline: none;
      border-color: #2196f3;
      background: #fff;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
      justify-content: center;
    }

    button {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
      color: white;
      background: #6c63ff;
    }

    button:active {
      transform: scale(0.98);
    }

    button.primary {
      background: #4caf50;
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
    }

    button.blue {
      background: #2196f3;
    }

    button.purple {
      background: #6c63ff;
    }

    button.red {
      background: #e53935;
    }

    button.gray {
      background: #607d8b;
      color: white;
    }

    .modes {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }

    .modes button {
      background: #e0e0e0;
      color: #555;
      flex: 1;
    }

    .modes button.active {
      background: #2196f3 !important;
      color: white;
      box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
    }

    /* Mobile fix styling */
    @media (max-width: 600px) {
      .container {
        margin: 10px;
        padding: 15px;
      }

      button {
        font-size: 14px;
        padding: 10px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”Š Äá»c & Dá»‹ch VÄƒn Báº£n</h1>

    <textarea id="text" placeholder="Nháº­p ná»™i dung vÃ o Ä‘Ã¢y..."></textarea>

    <div class="row">
      <button class="purple" onclick="copyText()">ğŸ“‹ Sao chÃ©p</button>
      <button class="purple" onclick="clearText()">âŒ XÃ³a</button>
    </div>

    <div class="row">
      <button class="purple" onclick="translateText('en')">ğŸ‡¬ğŸ‡§ Dá»‹ch sang Anh</button>
      <button class="purple" onclick="translateText('vi')">ğŸ‡»ğŸ‡³ Dá»‹ch sang Viá»‡t</button>
    </div>

    <h3 style="margin-top:20px; font-size: 1rem;">CÃ i Ä‘áº·t giá»ng Ä‘á»c</h3>
    <div class="modes">
      <button id="viBtn" class="active" onclick="setLang('vi-VN')">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
      <button id="enBtn" onclick="setLang('en-US')">ğŸ‡¬ğŸ‡§ English</button>
    </div>

    <div class="row" style="margin-top: 20px;">
      <button id="recordBtn" class="blue" onclick="toggleRecord()">ğŸ¤ Ghi Ã¢m</button>
    </div>

    <div class="row">
      <button class="primary" onclick="speak()">â–¶ï¸ Äá»ŒC NGAY</button>
      <button class="red" onclick="stopSpeak()">â¹ï¸ Dá»«ng Ä‘á»c</button>
    </div>

    <p id="status" style="font-size: 12px; color: #888; margin-top: 10px;"></p>
  </div>

  <script>
    // --- Cáº¤U HÃŒNH ---
    const textEl = document.getElementById("text");
    const recordBtn = document.getElementById("recordBtn");
    const viBtn = document.getElementById("viBtn");
    const enBtn = document.getElementById("enBtn");
    const statusEl = document.getElementById("status");
    let speakTimeout = null;

    let currentLang = "vi-VN";
    let isRecording = false;
    let recognition = null;
    let allVoices = [];

    // Kiá»ƒm tra thiáº¿t bá»‹
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    statusEl.innerText = isMobile ? "ğŸ“± Cháº¿ Ä‘á»™ Mobile" : "ğŸ’» Cháº¿ Ä‘á»™ PC";

    // --- Xá»¬ LÃ GIá»ŒNG Äá»ŒC ---

    // HÃ m láº¥y giá»ng (thá»­ nhiá»u láº§n vÃ¬ Mobile load cháº­m)
    function loadVoices() {
      allVoices = speechSynthesis.getVoices();
      if (allVoices.length === 0) {
        setTimeout(loadVoices, 100);
      }
    }

    // KÃ­ch hoáº¡t load giá»ng ngay láº­p tá»©c
    loadVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }

    function setLang(lang) {
      currentLang = lang;
      viBtn.classList.toggle("active", lang === "vi-VN");
      enBtn.classList.toggle("active", lang === "en-US");
    }

    function stopSpeak() {
      speechSynthesis.cancel();
    }

    function speak() {
      if (!textEl.value.trim()) {
        alert("Vui lÃ²ng nháº­p vÄƒn báº£n!");
        return;
      }

      speechSynthesis.cancel();

      if (speakTimeout) clearTimeout(speakTimeout);

      speakTimeout = setTimeout(() => {
        allVoices = speechSynthesis.getVoices();

        const utterance = new SpeechSynthesisUtterance(textEl.value);
        let selectedVoice = null;

        if (currentLang === "vi-VN") {
          selectedVoice = allVoices.find(v => v.lang === "vi-VN");

          if (!selectedVoice) {
            selectedVoice = allVoices.find(v =>
              v.name.includes("Vietnamese") || v.name.includes("Tiáº¿ng Viá»‡t")
            );
          }

          if (isMobile && !selectedVoice) {
            statusEl.innerText = "âš ï¸ KhÃ´ng cÃ³ giá»ng Viá»‡t, dÃ¹ng giá»ng Anh thay tháº¿.";
            selectedVoice = allVoices.find(v => v.lang === "en-US");
          }
        } else {
          selectedVoice = allVoices.find(v => v.lang === "en-US");
        }

        if (selectedVoice) {
          utterance.voice = selectedVoice;
          utterance.lang = selectedVoice.lang;
        } else {
          utterance.lang = currentLang;
        }

        utterance.rate = 1.0;
        utterance.pitch = 1.0;

        utterance.onerror = (e) => {
          console.warn("Speech error", e);

          if (isMobile) {
            speechSynthesis.cancel();
            const fb = new SpeechSynthesisUtterance(textEl.value);
            const enVoice = allVoices.find(v => v.lang === "en-US");
            if (enVoice) fb.voice = enVoice;
            fb.lang = "en-US";
            speechSynthesis.speak(fb);
          }
        };

        speechSynthesis.speak(utterance);
      }, 120); // 
    }


    // --- CÃC CHá»¨C NÄ‚NG KHÃC ---

    async function translateText(target) {
      if (!textEl.value.trim()) return alert("ChÆ°a cÃ³ ná»™i dung");
      statusEl.innerText = "â³ Äang dá»‹ch...";

      try {
        const source = target === "vi" ? "en" : "vi";
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${source}&tl=${target}&dt=t&q=${encodeURIComponent(textEl.value)}`;

        const res = await fetch(url);
        const data = await res.json();

        // GhÃ©p cÃ¡c Ä‘oáº¡n dá»‹ch láº¡i (Ä‘á» phÃ²ng vÄƒn báº£n dÃ i)
        let translatedText = "";
        data[0].forEach(item => {
          if (item[0]) translatedText += item[0];
        });

        textEl.value = translatedText;
        setLang(target === "vi" ? "vi-VN" : "en-US");
        statusEl.innerText = "âœ… ÄÃ£ dá»‹ch xong";
      } catch (e) {
        alert("Lá»—i káº¿t ná»‘i dá»‹ch thuáº­t");
        statusEl.innerText = "";
      }
    }

    function copyText() {
      if (!textEl.value) return;
      navigator.clipboard.writeText(textEl.value);
      statusEl.innerText = "ğŸ“‹ ÄÃ£ sao chÃ©p vÃ o bá»™ nhá»› táº¡m";
      setTimeout(() => statusEl.innerText = "", 2000);
    }

    function clearText() {
      textEl.value = "";
      statusEl.innerText = "";
    }

    function toggleRecord() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ ghi Ã¢m");
        return;
      }

      if (!recognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false; // Chá»‰ láº¥y káº¿t quáº£ cuá»‘i cÃ¹ng Ä‘á»ƒ Ä‘á»¡ lá»—i
        recognition.lang = currentLang;

        recognition.onstart = () => {
          isRecording = true;
          recordBtn.textContent = "â¹ï¸ Dá»«ng Ghi";
          recordBtn.classList.add("red");
          recordBtn.classList.remove("blue");
          statusEl.innerText = "ğŸ™ï¸ Äang láº¯ng nghe...";
        };

        recognition.onresult = e => {
          let text = "";
          for (let i = e.resultIndex; i < e.results.length; i++) {
            if (e.results[i].isFinal) {
              text += e.results[i][0].transcript;
            }
          }
          // ThÃªm khoáº£ng tráº¯ng náº¿u cÃ³ ná»™i dung cÅ©
          textEl.value += (textEl.value ? " " : "") + text;
        };

        recognition.onerror = (e) => {
          console.error(e);
          stopRecordUI();
          statusEl.innerText = "âŒ Lá»—i ghi Ã¢m (Micro hoáº·c máº¡ng)";
        };

        recognition.onend = () => {
          stopRecordUI();
        };
      }

      if (isRecording) {
        recognition.stop();
      } else {
        recognition.lang = currentLang;
        recognition.start();
      }
    }

    function stopRecordUI() {
      isRecording = false;
      recordBtn.textContent = "ğŸ¤ Ghi Ã¢m";
      recordBtn.classList.remove("red");
      recordBtn.classList.add("blue");
      statusEl.innerText = "";
    }
  </script>
</body>

</html>