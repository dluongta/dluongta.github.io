<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Text Speech</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4f6f8;
    }

    .container {
      max-width: 680px;
      margin: 30px auto;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0,0,0,.1);
      text-align: center;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      padding: 15px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .row {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #6c63ff;
      color: #fff;
    }

    .primary { background: #4caf50; }
    .blue { background: #2196f3; }
    .red { background: #e53935; }

    .modes {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .active {
      background: #2196f3 !important;
      font-weight: bold;
    }
  </style>
</head>

<body>
<div class="container">
  <h2>ğŸ”Š Text â†’ Speech (Mobile OK)</h2>

  <textarea id="text" placeholder="Nháº­p hoáº·c ghi Ã¢m ná»™i dung..."></textarea>

  <div class="row">
    <button onclick="copyText()">ğŸ“‹ Sao chÃ©p</button>
    <button onclick="clearText()">âŒ XÃ³a</button>
  </div>

  <div class="row">
    <button onclick="translateText('en')">ğŸŒ English</button>
    <button onclick="translateText('vi')">ğŸŒ Tiáº¿ng Viá»‡t</button>
  </div>

  <h3>ğŸ™ï¸ NgÃ´n ngá»¯ Ä‘á»c</h3>
  <div class="modes">
    <button id="viBtn" class="active" onclick="setLang('vi')">ğŸ‡»ğŸ‡³ Viá»‡t</button>
    <button id="enBtn" onclick="setLang('en')">ğŸ‡ºğŸ‡¸ English</button>
  </div>

  <div class="row">
    <button id="recordBtn" class="blue" onclick="toggleRecord()">ğŸ¤ Ghi Ã¢m</button>
  </div>

  <div class="row">
    <button class="primary" onclick="speak()">â–¶ï¸ Äá»c ngay</button>
  </div>
</div>

<script>
const textEl = document.getElementById("text");
const viBtn = document.getElementById("viBtn");
const enBtn = document.getElementById("enBtn");
const recordBtn = document.getElementById("recordBtn");

let currentLang = "vi";
let recognition = null;
let isRecording = false;
let audio = new Audio();

function setLang(lang) {
  currentLang = lang;
  viBtn.classList.toggle("active", lang === "vi");
  enBtn.classList.toggle("active", lang === "en");
}

/* ===== TEXT TO SPEECH (GOOGLE TRANSLATE TTS) ===== */
function speak() {
  if (!textEl.value.trim()) {
    alert("Vui lÃ²ng nháº­p vÄƒn báº£n");
    return;
  }

  const chunks = textEl.value.match(/.{1,180}/g);
  let index = 0;
  const audio = new Audio();

  audio.onended = () => {
    index++;
    if (index < chunks.length) play();
  };

  audio.onerror = () => {
    alert("KhÃ´ng thá»ƒ phÃ¡t Ã¢m thanh. HÃ£y má»Ÿ báº±ng HTTPS.");
  };

  function play() {
    const text = encodeURIComponent(chunks[index]);
    const lang = currentLang === "vi" ? "vi" : "en";

    audio.src =
      `https://translate.googleapis.com/translate_tts?ie=UTF-8&client=gtx&tl=${lang}&q=${text}`;

    audio.play().catch(err => {
      console.error(err);
    });
  }

  play();
}

/* ===== TRANSLATE ===== */
async function translateText(target) {
  if (!textEl.value.trim()) return;

  const source = target === "vi" ? "en" : "vi";
  const url =
    `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${source}&tl=${target}&dt=t&q=${encodeURIComponent(textEl.value)}`;

  const res = await fetch(url);
  const data = await res.json();
  textEl.value = data[0][0][0];
  setLang(target);
}

/* ===== RECORD ===== */
function toggleRecord() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ ghi Ã¢m");

  if (!recognition) {
    recognition = new SpeechRecognition();
    recognition.lang = currentLang === "vi" ? "vi-VN" : "en-US";
    recognition.continuous = true;

    recognition.onresult = e => {
      for (let i = e.resultIndex; i < e.results.length; i++) {
        if (e.results[i].isFinal) {
          textEl.value += e.results[i][0].transcript;
        }
      }
    };

    recognition.onend = () => {
      isRecording = false;
      recordBtn.textContent = "ğŸ¤ Ghi Ã¢m";
      recordBtn.classList.remove("red");
    };
  }

  if (isRecording) {
    recognition.stop();
  } else {
    recognition.lang = currentLang === "vi" ? "vi-VN" : "en-US";
    recognition.start();
    isRecording = true;
    recordBtn.textContent = "â¹ï¸ Dá»«ng";
    recordBtn.classList.add("red");
  }
}

/* ===== UTILS ===== */
function copyText() {
  navigator.clipboard.writeText(textEl.value);
  alert("ÄÃ£ sao chÃ©p");
}

function clearText() {
  textEl.value = "";
}
</script>
</body>
</html>
